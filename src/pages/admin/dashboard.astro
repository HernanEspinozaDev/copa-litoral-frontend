---
// src/pages/admin/dashboard.astro
import AdminLayout from '@layouts/AdminLayout.astro';
import { getTournaments, getPlayers, getMatches, getContactRecords, getSponsors } from '@lib/database';

// Obtener datos reales de la base de datos
const tournaments = getTournaments();
const players = getPlayers();
const matches = getMatches();
const contactRecords = getContactRecords() || [];
const sponsors = getSponsors();

// Calcular estadísticas
const stats = {
  tournaments: tournaments.length,
  players: players.length,
  matches: matches.length,
  sponsors: sponsors.length
};

// Obtener torneos activos (los que tienen fecha futura)
const currentDate = new Date();
const activeTournaments = tournaments
  .filter(tournament => new Date(tournament.date) >= currentDate)
  .sort((a, b) => new Date(a.date).getTime() - new Date(b.date).getTime())
  .slice(0, 3);

// Obtener últimos jugadores registrados
const recentPlayers = [...players]
  .sort((a, b) => new Date(b.id).getTime() - new Date(a.id).getTime())
  .slice(0, 5);

// Obtener últimos partidos
const recentMatches = [...matches]
  .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime())
  .slice(0, 5);

// Calcular estadísticas adicionales
const matchesThisMonth = matches.filter(match => {
  const matchDate = new Date(match.date);
  return matchDate.getMonth() === currentDate.getMonth() &&
         matchDate.getFullYear() === currentDate.getFullYear();
}).length;

const playersThisMonth = players.filter(player => {
  const playerDate = new Date(player.id);
  return playerDate.getMonth() === currentDate.getMonth() &&
         playerDate.getFullYear() === currentDate.getFullYear();
}).length;
---

<AdminLayout>
  <!-- Resumen de Estadísticas -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
      <div class="flex items-center">
        <div class="p-3 rounded-full bg-blue-100 mr-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" viewBox="0 0 20 20" fill="currentColor">
            <path d="M6 4a2 2 0 012-2h4a2 2 0 012 2v14l-5-2.5L4 18V4z" />
          </svg>
        </div>
        <div>
          <p class="text-sm font-medium text-gray-600">Torneos Activos</p>
          <p class="text-2xl font-bold text-gray-900">{stats.tournaments}</p>
        </div>
      </div>
      <div class="mt-4">
        <div class="flex items-center">
          <span class="text-green-500 text-sm font-medium">↑ 12%</span>
          <span class="text-gray-500 text-sm ml-2">vs mes anterior</span>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
      <div class="flex items-center">
        <div class="p-3 rounded-full bg-green-100 mr-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" viewBox="0 0 20 20" fill="currentColor">
            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" />
          </svg>
        </div>
        <div>
          <p class="text-sm font-medium text-gray-600">Jugadores Registrados</p>
          <p class="text-2xl font-bold text-gray-900">{stats.players}</p>
        </div>
      </div>
      <div class="mt-4">
        <div class="flex items-center">
          <span class="text-green-500 text-sm font-medium">↑ 8%</span>
          <span class="text-gray-500 text-sm ml-2">vs mes anterior</span>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
      <div class="flex items-center">
        <div class="p-3 rounded-full bg-purple-100 mr-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H5zm0 2h10v7h-2l-1 2H8l-1-2H5V5z" clip-rule="evenodd" />
          </svg>
        </div>
        <div>
          <p class="text-sm font-medium text-gray-600">Partidos Jugados</p>
          <p class="text-2xl font-bold text-gray-900">{stats.matches}</p>
        </div>
      </div>
      <div class="mt-4">
        <div class="flex items-center">
          <span class="text-green-500 text-sm font-medium">↑ 15%</span>
          <span class="text-gray-500 text-sm ml-2">vs mes anterior</span>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
      <div class="flex items-center">
        <div class="p-3 rounded-full bg-yellow-100 mr-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-600" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M6.672 1.911a1 1 0 10-1.932.518l.259.966a1 1 0 001.932-.518l-.26-.966zM2.429 4.74a1 1 0 10-.517 1.932l.966.259a1 1 0 00.517-1.932l-.966-.26zm8.814-.569a1 1 0 00-1.415-1.414l-.707.707a1 1 0 101.415 1.415l.707-.708zm-7.071 7.072l.707-.707A1 1 0 003.465 9.12l-.708.707a1 1 0 001.415 1.415zm3.2-5.171a1 1 0 00-1.3 1.3l4 10a1 1 0 001.823.075l1.38-2.759 3.018 3.02a1 1 0 001.414-1.415l-3.019-3.02 2.76-1.379a1 1 0 00-.076-1.822l-10-4z" clip-rule="evenodd" />
          </svg>
        </div>
        <div>
          <p class="text-sm font-medium text-gray-600">Patrocinadores</p>
          <p class="text-2xl font-bold text-gray-900">{stats.sponsors}</p>
        </div>
      </div>
      <div class="mt-4">
        <div class="flex items-center">
          <span class="text-green-500 text-sm font-medium">↑ 4%</span>
          <span class="text-gray-500 text-sm ml-2">vs mes anterior</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráficos y Datos -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Torneos Activos -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Torneos Activos</h2>
      <div class="space-y-4">
        {activeTournaments.map((tournament) => (
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <div>
              <h3 class="font-medium text-gray-900">{tournament.name}</h3>
              <p class="text-sm text-gray-500">{tournament.date}</p>
            </div>
            <div class="flex items-center space-x-2">
              <span class="px-2 py-1 text-xs font-medium text-green-800 bg-green-100 rounded-full">Activo</span>
              <a href={`/admin/torneos/editar/${tournament.id}`} class="text-blue-600 hover:text-blue-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                </svg>
              </a>
            </div>
          </div>
        ))}
      </div>
    </div>

    <!-- Últimos Jugadores -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Últimos Jugadores Registrados</h2>
      <div class="overflow-hidden">
        <table class="min-w-full">
          <thead>
            <tr class="border-b border-gray-200">
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            {recentPlayers.map((player) => (
              <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{player.name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{player.category}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{player.email}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Últimos Contactos -->
  <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200 mb-8">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Mensajes Recientes</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead>
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mensaje</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {contactRecords.map(record => (
            <tr>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{record.name}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{record.email}</td>
              <td class="px-6 py-4 text-sm text-gray-500">{record.message}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                {new Date(record.date).toLocaleDateString()}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 py-1 text-xs font-medium text-yellow-800 bg-yellow-100 rounded-full">
                  Pendiente
                </span>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Scripts para gráficos y funcionalidad -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Eliminar torneos
    document.querySelectorAll('.delete-tournament').forEach(button => {
      button.addEventListener('click', async (e) => {
        const tournamentId = e.target.dataset.id;
        if (confirm('¿Estás seguro de que deseas eliminar este torneo?')) {
          try {
            const response = await fetch(`/api/torneos/delete/${tournamentId}`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            if (response.ok) {
              alert('Torneo eliminado correctamente');
              window.location.reload();
            } else {
              const error = await response.json();
              alert(error.message || 'Error al eliminar el torneo');
            }
          } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión al servidor');
          }
        }
      });
    });
  </script>
</AdminLayout>
</AdminLayout>
