---
import AdminLayout from '@layouts/AdminLayout.astro';
import { promises as fs } from 'fs';
import path from 'path';

const categories = ["1ª Categoría", "2ª Categoría", "3ª Categoría", "4ª Categoría"];
const dataFilePath = path.resolve(process.cwd(), 'src/data/tournaments.json');

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const anio = formData.get('anio') as string;
    const titulo = formData.get('titulo') as string;
    const fechaInicioValue = formData.get('fechaInicio') as string;
    const fechaFinValue = formData.get('fechaFin') as string;

    const formatDate = (date) => {
      return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
    };

    const newTournament = {
      id: `${titulo.replace(/\s+/g, '-').toLowerCase()}-${anio}`,
      titulo: titulo,
      anio: parseInt(anio),
      lugar: formData.get('lugar') as string,
      fechas: `Del ${formatDate(new Date(fechaInicioValue + 'T00:00:00'))} al ${formatDate(new Date(fechaFinValue + 'T00:00:00'))}`,
      fechaInicio: fechaInicioValue,
      fechaFin: fechaFinValue,
      estado: formData.get('estado') as string,
      categorias: formData.getAll('categorias') as string[],
      totalJugadores: 0,
      formato: formData.get('formato') as string,
      precio: `$${formData.get('precioSocios')} socios / $${formData.get('precioGeneral')} general`,
      bases: formData.get('bases') as string,
      precioSocios: formData.get('precioSocios') as string,
      precioGeneral: formData.get('precioGeneral') as string,
      fechaLimiteInscripcion: formData.get('fechaLimiteInscripcion') as string,
    };

    const fileContent = await fs.readFile(dataFilePath, 'utf-8');
    const tournaments = JSON.parse(fileContent);

    if (tournaments.some(t => t.id === newTournament.id)) {
      // Handle error, maybe render the form again with an error message
    } else {
      tournaments.push(newTournament);
      await fs.writeFile(dataFilePath, JSON.stringify(tournaments, null, 2));
      return Astro.redirect('/admin/torneos');
    }
  } catch (error) {
    console.error(error);
    // Handle error
  }
}
---

<AdminLayout>
  <slot name="title" slot="title">Nuevo Torneo - Copa Litoral</slot>
  <slot name="description" slot="description">Crear un nuevo torneo con información detallada</slot>
  
  <div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-6 text-primary">Crear Nuevo Torneo</h1>
    
    <form method="POST" class="bg-white p-8 rounded-2xl shadow-lg space-y-8">
      <!-- Form fields remain the same -->
      <div class="p-6 border rounded-xl">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Información General</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="col-span-2">
            <label for="titulo" class="block text-gray-700 font-bold mb-2">Título del Torneo</label>
            <input type="text" id="titulo" name="titulo" placeholder="Ej: Copa Litoral 2025" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" />
          </div>
          <div>
            <label for="anio" class="block text-gray-700 font-bold mb-2">Año</label>
            <input type="number" id="anio" name="anio" placeholder="Ej: 2025" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" />
          </div>
          <div>
            <label for="estado" class="block text-gray-700 font-bold mb-2">Estado del Torneo</label>
            <select id="estado" name="estado" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
              <option value="proximamente">Próximamente</option>
              <option value="inscripciones-abiertas">Inscripciones Abiertas</option>
              <option value="en-juego">En Juego</option>
              <option value="finalizado">Finalizado</option>
            </select>
          </div>
          <div class="col-span-2">
            <label for="lugar" class="block text-gray-700 font-bold mb-2">Lugar</label>
            <input type="text" id="lugar" name="lugar" placeholder="Ej: Club de Tenis Montemar, San Antonio" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" />
          </div>
          <div>
            <label for="fechaInicio" class="block text-gray-700 font-bold mb-2">Fecha de Inicio</label>
            <input type="date" id="fechaInicio" name="fechaInicio" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" />
          </div>
          <div>
            <label for="fechaFin" class="block text-gray-700 font-bold mb-2">Fecha de Fin</label>
            <input type="date" id="fechaFin" name="fechaFin" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" />
          </div>
        </div>
      </div>

      <div class="p-6 border rounded-xl">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Categorías y Formato</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-gray-700 font-bold mb-2">Categorías Disponibles</label>
            <div id="categorias-container" class="p-2 border rounded-lg">
              {categories.map(cat => (
                <label class="flex items-center p-2 hover:bg-gray-100 rounded-md">
                  <input type="checkbox" name="categorias" value={cat} class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"/>
                  <span class="ml-3 text-gray-700">{cat}</span>
                </label>
              ))}
            </div>
          </div>
          <div>
            <label for="formato" class="block text-gray-700 font-bold mb-2">Formato del Torneo</label>
            <textarea id="formato" name="formato" rows="4" placeholder="Ej: Sistema de grupos + semifinales" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
          </div>
        </div>
      </div>

      <div class="p-6 border rounded-xl">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Inscripciones</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="precioSocios" class="block text-gray-700 font-bold mb-2">Precio Socios ($)</label>
            <input type="number" id="precioSocios" name="precioSocios" placeholder="18000" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" />
          </div>
          <div>
            <label for="precioGeneral" class="block text-gray-700 font-bold mb-2">Precio General ($)</label>
            <input type="number" id="precioGeneral" name="precioGeneral" placeholder="23000" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" />
          </div>
          <div class="col-span-2">
            <label for="fechaLimiteInscripcion" class="block text-gray-700 font-bold mb-2">Fecha Límite de Inscripción</label>
            <input type="date" id="fechaLimiteInscripcion" name="fechaLimiteInscripcion" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" />
          </div>
        </div>
      </div>

      <div class="p-6 border rounded-xl">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Bases del Torneo</h2>
        <div>
          <label for="bases" class="block text-gray-700 font-bold mb-2">Contenido de las Bases</label>
          <textarea id="bases" name="bases" rows="10" placeholder="Copia y pega las bases del torneo aquí..." required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
        </div>
      </div>
      
      <div class="flex justify-end space-x-4 pt-4">
        <a href="/admin/torneos" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-300">
          Cancelar
        </a>
        <button type="submit" class="bg-primary hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
          Crear Torneo
        </button>
      </div>
    </form>
  </div>
  
  <script>
    // Client-side validation script remains the same
    const anioInput = document.getElementById('anio');
    const fechaInicioInput = document.getElementById('fechaInicio');
    const fechaFinInput = document.getElementById('fechaFin');
    const fechaLimiteInscripcionInput = document.getElementById('fechaLimiteInscripcion');

    function setMinDateForDeadline() {
      const today = new Date().toISOString().split('T')[0];
      fechaLimiteInscripcionInput.min = today;
    }

    function updateDateLimits() {
      const year = anioInput.value;
      if (year) {
        fechaInicioInput.min = `${year}-01-01`;
        fechaInicioInput.max = `${year}-12-31`;
        fechaFinInput.min = `${year}-01-01`;
        fechaFinInput.max = `${year}-12-31`;
      } else {
        fechaInicioInput.min = null;
        fechaInicioInput.max = null;
        fechaFinInput.min = null;
        fechaFinInput.max = null;
      }
    }

    anioInput.addEventListener('change', updateDateLimits);
    fechaInicioInput.addEventListener('change', () => {
      if (fechaInicioInput.value) {
        fechaFinInput.min = fechaInicioInput.value;
        const startDate = new Date(fechaInicioInput.value + 'T00:00:00');
        startDate.setDate(startDate.getDate() - 1);
        fechaLimiteInscripcionInput.max = startDate.toISOString().split('T')[0];
      }
    });

    updateDateLimits();
    setMinDateForDeadline();
  </script>
</AdminLayout>